# 期权策略功能 - 核心代码指南

**创建日期**: 2024-10-22  
**状态**: ✅ 已部署成功  
**用途**: 期权策略推荐系统的核心代码说明和扩展指南

---

## 📋 核心文件结构

### 后端核心文件（3个）

#### 1️⃣ `backend/algorithms/option_nlp_parser.py`
**功能**: 自然语言解析器，提取用户投资意图

**核心类和方法**:
```python
class ParsedIntent:
    ticker: str          # 股票代码 (TSLA, AAPL等)
    direction: str       # 方向 (bullish, bearish, neutral)
    strength: str        # 强度 (strong, moderate, slight)
    timeframe: str       # 时间 (short, medium, long)
    risk_profile: str    # 风险偏好 (aggressive, balanced, conservative)
    confidence: float    # 解析置信度

class OptionParser:
    def parse(self, user_input: str) -> ParsedIntent
        # 解析用户输入，返回意图对象
```

**关键词字典**:
- `direction_keywords`: 看涨/看跌/震荡关键词
- `strength_keywords`: 强度关键词
- `timeframe_keywords`: 时间关键词
- `risk_keywords`: 风险偏好关键词
- `ticker_map`: 中文股票名称到代码的映射

**如何修改**:
- 添加新股票: 修改 `ticker_map`
- 添加新关键词: 修改各个 `*_keywords` 字典
- 调整置信度计算: 修改 `_calculate_confidence()` 方法

---

#### 2️⃣ `backend/algorithms/option_strategy_mapper.py`
**功能**: 策略映射器，根据意图推荐期权策略并计算payoff

**核心类和方法**:
```python
class StrategyParameters:
    current_price: float      # 当前股价
    buy_strike: float         # 买入执行价
    sell_strike: float        # 卖出执行价
    premium_paid: float       # 支付的权利金
    premium_received: float   # 收到的权利金
    contracts: int            # 合约数量
    expiry: str               # 到期时间

class StrategyMetrics:
    max_loss: float      # 最大损失
    max_gain: float      # 最大收益
    breakeven: float     # 盈亏平衡点
    probability: str     # 成功概率

class OptionStrategy:
    name: str                  # 策略名称
    type: str                  # 策略类型
    description: str           # 策略描述
    parameters: Dict           # 策略参数
    metrics: Dict              # 策略指标
    payoff_data: List[Dict]    # Payoff曲线数据
    risk_level: str            # 风险等级

class StrategyMapper:
    def map_strategy(self, intent: ParsedIntent, current_price: float) -> OptionStrategy
        # 映射策略
    
    def _calculate_parameters(self, strategy_type: str, current_price: float, timeframe: str)
        # 计算策略参数
    
    def _calculate_metrics(self, strategy_type: str, params: StrategyParameters)
        # 计算策略指标
    
    def _generate_payoff(self, strategy_type: str, params: StrategyParameters)
        # 生成payoff曲线
```

**策略映射规则** (`strategy_rules`):
```python
{
    ('bullish', 'strong', 'aggressive'): {
        'name': '买入平值看涨期权',
        'type': 'long_call',
        'description': '...',
        'risk': '高'
    },
    # ... 更多策略规则
}
```

**支持的策略类型**:
- `long_call`: 买入看涨期权
- `long_put`: 买入看跌期权
- `bull_call_spread`: 牛市价差
- `bear_put_spread`: 熊市价差
- `sell_otm_put`: 卖出虚值看跌
- `iron_condor`: 铁鹰式
- `iron_butterfly`: 铁蝶式
- `short_straddle`: 卖出跨式

**如何修改**:
- 添加新策略: 在 `strategy_rules` 中添加新规则
- 修改策略参数: 修改 `_calculate_parameters()` 方法
- 修改风险指标: 修改 `_calculate_metrics()` 方法
- 修改payoff计算: 修改 `_calculate_payoff_at_price()` 方法

---

#### 3️⃣ `backend/option_strategy_handler.py`
**功能**: 整合NLP和策略映射，处理完整请求流程

**核心类和方法**:
```python
class OptionStrategyHandler:
    def is_option_strategy_request(self, user_input: str) -> bool
        # 判断是否是期权策略请求
    
    def handle_option_strategy_request(self, user_input: str, current_price: float) -> Dict
        # 处理期权策略请求，返回完整结果
    
    def generate_text_response(self, result: Dict) -> str
        # 生成文字形式的回复
```

**返回结果结构**:
```python
{
    'success': True,
    'parsed_intent': {
        'ticker': 'TSLA',
        'direction': 'bullish',
        'strength': 'strong',
        'timeframe': 'short',
        'risk_profile': 'aggressive',
        'confidence': 0.9
    },
    'strategy': {
        'name': '买入平值看涨期权',
        'type': 'long_call',
        'description': '...',
        'risk_level': '高',
        'parameters': {...},
        'metrics': {...},
        'payoff_data': [
            {'price': 280.0, 'payoff': -1200.0},
            {'price': 280.8, 'payoff': -1120.0},
            # ... 101个数据点
        ]
    }
}
```

**如何修改**:
- 调整关键词检测: 修改 `option_keywords` 列表
- 调整置信度阈值: 修改 `handle_option_strategy_request()` 中的 `0.3`
- 修改默认股价: 修改 `price_map` 字典
- 自定义文字回复: 修改 `generate_text_response()` 方法

---

#### 4️⃣ `backend/app.py`
**功能**: Flask应用主文件，API端点

**关键代码位置**:

**导入期权处理器** (第68-77行):
```python
from option_strategy_handler import OptionStrategyHandler
option_handler = OptionStrategyHandler()
OPTION_STRATEGY_AVAILABLE = True
```

**专用API端点** (第413-437行):
```python
@app.route('/api/options/strategy', methods=['POST', 'OPTIONS'])
def option_strategy():
    # 专用的期权策略API
    result = option_handler.handle_option_strategy_request(user_input, current_price)
    return jsonify(result), 200
```

**聊天集成** (第454-480行):
```python
# 在聊天API中检测期权请求
if option_handler.is_option_strategy_request(message):
    option_result = option_handler.handle_option_strategy_request(message)
    return jsonify({
        "response": text_response,
        "option_strategy_used": True,
        "option_strategy_result": option_result
    })
```

---

### 前端核心文件（2个）

#### 5️⃣ `frontend/src/OptionStrategy.js`
**功能**: 期权策略可视化组件（模态框）

**核心功能**:
- 显示识别的投资意图
- 显示推荐策略详情
- 显示策略参数和风险指标
- **使用Chart.js绘制Payoff曲线图**

**Props**:
```javascript
{
  optionResult: {
    parsed_intent: {...},
    strategy: {...}
  },
  onClose: () => void
}
```

**Chart.js配置**:
```javascript
new Chart(ctx, {
  type: 'line',
  data: {
    labels: payoffData.map(d => d.price),
    datasets: [{
      label: 'Profit/Loss ($)',
      data: payoffData.map(d => d.payoff),
      // 盈利显示绿色，亏损显示红色
    }]
  },
  options: {
    // X轴: 股价
    // Y轴: 损益
    // 在Y=0处加粗横线
  }
})
```

**如何修改**:
- 修改样式: 修改 `styles` 对象
- 修改图表外观: 修改Chart.js的 `options`
- 添加新的显示内容: 在JSX中添加新section

---

#### 6️⃣ `frontend/src/App.js`
**功能**: React主应用，集成期权策略功能

**关键代码位置**:

**导入组件** (第5行):
```javascript
import OptionStrategy from './OptionStrategy';
```

**状态管理** (第27-29行):
```javascript
const [optionStrategyResult, setOptionStrategyResult] = useState(null);
const [showOptionStrategy, setShowOptionStrategy] = useState(false);
```

**检测API响应** (第214-219行):
```javascript
// 在sendMessage中检查API响应
if (data.option_strategy_used && data.option_strategy_result) {
  setOptionStrategyResult(data.option_strategy_result);
  setShowOptionStrategy(true);
}
```

**渲染模态框** (第758-767行):
```javascript
{showOptionStrategy && optionStrategyResult && (
  <OptionStrategy
    optionResult={optionStrategyResult}
    onClose={() => {
      setShowOptionStrategy(false);
      setOptionStrategyResult(null);
    }}
  />
)}
```

---

## 🎯 添加期权定价功能 - 需要关注的地方

### 方案1: 简化的Black-Scholes模型

**需要修改的文件**: `backend/algorithms/option_strategy_mapper.py`

**添加定价函数**:
```python
import math
from scipy.stats import norm

def black_scholes_call(S, K, T, r, sigma):
    """
    Black-Scholes看涨期权定价
    S: 当前股价
    K: 执行价
    T: 到期时间（年）
    r: 无风险利率
    sigma: 波动率
    """
    d1 = (math.log(S/K) + (r + 0.5*sigma**2)*T) / (sigma*math.sqrt(T))
    d2 = d1 - sigma*math.sqrt(T)
    call_price = S*norm.cdf(d1) - K*math.exp(-r*T)*norm.cdf(d2)
    return call_price

def black_scholes_put(S, K, T, r, sigma):
    """Black-Scholes看跌期权定价"""
    call_price = black_scholes_call(S, K, T, r, sigma)
    put_price = call_price - S + K*math.exp(-r*T)
    return put_price
```

**修改位置**: 在 `_calculate_parameters()` 方法中使用

**替换**:
```python
# 当前简化方式
params.premium_paid = current_price * 0.04  # 4%作为权利金

# 改为BS定价
T = 30/365  # 30天到期
r = 0.05    # 5%无风险利率
sigma = 0.3 # 30%波动率
params.premium_paid = black_scholes_call(
    S=current_price,
    K=params.buy_strike,
    T=T,
    r=r,
    sigma=sigma
)
```

---

### 方案2: 实时市场数据集成

**需要修改的文件**: `backend/option_strategy_handler.py`

**添加实时价格获取**:
```python
import yfinance as yf

def get_real_time_price(ticker: str) -> float:
    """获取实时股价"""
    try:
        stock = yf.Ticker(ticker)
        return stock.info['currentPrice']
    except:
        return 300.0  # 默认值

def get_implied_volatility(ticker: str) -> float:
    """获取隐含波动率"""
    try:
        stock = yf.Ticker(ticker)
        options = stock.option_chain(stock.options[0])
        # 计算ATM期权的隐含波动率
        return calculate_iv(options)
    except:
        return 0.3  # 默认30%
```

**修改 `handle_option_strategy_request()`**:
```python
# 获取实时数据
if intent.ticker:
    current_price = get_real_time_price(intent.ticker)
    volatility = get_implied_volatility(intent.ticker)
else:
    current_price = 300.0
    volatility = 0.3

# 传递给mapper
strategy = self.mapper.map_strategy(
    intent, 
    current_price,
    volatility=volatility  # 新参数
)
```

---

### 方案3: 希腊字母计算（Greeks）

**需要添加的功能**:
- Delta (Δ): 价格敏感度
- Gamma (Γ): Delta变化率
- Theta (Θ): 时间衰减
- Vega (ν): 波动率敏感度
- Rho (ρ): 利率敏感度

**添加到**: `backend/algorithms/option_strategy_mapper.py`

```python
@dataclass
class StrategyGreeks:
    delta: float
    gamma: float
    theta: float
    vega: float
    rho: float

def calculate_greeks(S, K, T, r, sigma, option_type='call'):
    """计算期权希腊字母"""
    d1 = (math.log(S/K) + (r + 0.5*sigma**2)*T) / (sigma*math.sqrt(T))
    d2 = d1 - sigma*math.sqrt(T)
    
    if option_type == 'call':
        delta = norm.cdf(d1)
    else:  # put
        delta = norm.cdf(d1) - 1
    
    gamma = norm.pdf(d1) / (S * sigma * math.sqrt(T))
    theta = -((S * norm.pdf(d1) * sigma) / (2 * math.sqrt(T))) - \
            r * K * math.exp(-r*T) * norm.cdf(d2)
    vega = S * norm.pdf(d1) * math.sqrt(T)
    rho = K * T * math.exp(-r*T) * norm.cdf(d2)
    
    return StrategyGreeks(delta, gamma, theta, vega, rho)
```

**在OptionStrategy中返回Greeks**:
```python
class OptionStrategy:
    # ... 现有字段
    greeks: Dict  # 新增字段
```

**前端显示Greeks**:
在 `frontend/src/OptionStrategy.js` 中添加新section:
```javascript
{/* 希腊字母 */}
<div style={styles.section}>
  <h3 style={styles.sectionTitle}>📐 希腊字母（Greeks）</h3>
  <div style={styles.greeksGrid}>
    <div>Delta: {strategy.greeks.delta.toFixed(3)}</div>
    <div>Gamma: {strategy.greeks.gamma.toFixed(3)}</div>
    <div>Theta: {strategy.greeks.theta.toFixed(2)}</div>
    <div>Vega: {strategy.greeks.vega.toFixed(2)}</div>
  </div>
</div>
```

---

## 📦 需要安装的依赖

### 后端依赖

**基础期权定价**:
```bash
pip install scipy
```

**实时数据获取**:
```bash
pip install yfinance
pip install pandas
```

**高级期权计算**:
```bash
pip install py_vollib  # 隐含波动率计算
pip install QuantLib   # 完整的期权定价库
```

**更新 `backend/requirements.txt`**:
```txt
scipy>=1.9.0
yfinance>=0.2.0
pandas>=1.5.0
py-vollib>=1.0.1
```

---

## 🔧 推荐的扩展顺序

### 阶段1: 改进定价模型（简单）
1. 添加Black-Scholes定价函数
2. 替换现有的固定百分比计算
3. 测试不同股价下的期权价格

**修改文件**: `option_strategy_mapper.py`  
**难度**: ⭐⭐☆☆☆

---

### 阶段2: 集成实时数据（中等）
1. 安装 `yfinance`
2. 添加实时价格获取
3. 获取历史波动率
4. 动态调整策略参数

**修改文件**: `option_strategy_handler.py`, `option_strategy_mapper.py`  
**难度**: ⭐⭐⭐☆☆

---

### 阶段3: 添加希腊字母（中等）
1. 实现Greeks计算函数
2. 添加到策略返回结果
3. 前端显示Greeks
4. 添加Greeks解释说明

**修改文件**: `option_strategy_mapper.py`, `OptionStrategy.js`  
**难度**: ⭐⭐⭐☆☆

---

### 阶段4: 高级功能（复杂）
1. 隐含波动率计算
2. 多腿策略优化
3. 蒙特卡洛模拟
4. 风险分析报告

**需要新文件**: `option_pricing.py`, `risk_analysis.py`  
**难度**: ⭐⭐⭐⭐⭐

---

## 🎨 前端改进建议

### 添加交互式参数调整

**在 `OptionStrategy.js` 中添加滑块**:
```javascript
<div style={styles.section}>
  <h3>🎛️ 参数调整</h3>
  <label>
    股价: ${stockPrice}
    <input 
      type="range" 
      min={currentPrice * 0.8} 
      max={currentPrice * 1.2}
      value={stockPrice}
      onChange={(e) => updateStockPrice(e.target.value)}
    />
  </label>
  
  <label>
    波动率: {volatility}%
    <input 
      type="range" 
      min={10} 
      max={80}
      value={volatility}
      onChange={(e) => updateVolatility(e.target.value)}
    />
  </label>
</div>
```

### 添加多策略对比

**显示2-3个策略供用户选择**:
```javascript
const [strategies, setStrategies] = useState([
  strategy1, strategy2, strategy3
]);

<div style={styles.strategyList}>
  {strategies.map((strat, idx) => (
    <div 
      key={idx}
      onClick={() => selectStrategy(strat)}
      style={styles.strategyCard}
    >
      <h4>{strat.name}</h4>
      <p>风险: {strat.risk_level}</p>
    </div>
  ))}
</div>
```

---

## 📚 学习资源

### Black-Scholes模型
- [Wikipedia: Black-Scholes model](https://en.wikipedia.org/wiki/Black%E2%80%93Scholes_model)
- Python实现示例

### 期权希腊字母
- Delta, Gamma, Theta, Vega, Rho的含义
- 如何使用Greeks进行风险管理

### Python期权库
- `py_vollib`: 隐含波动率计算
- `QuantLib`: 完整的量化金融库
- `yfinance`: 免费市场数据

---

## 🚨 注意事项

1. **免责声明**: 期权交易有高风险，系统仅供教育和参考
2. **数据延迟**: 免费API可能有15-20分钟延迟
3. **准确性**: 简化模型可能与市场实际价格有差异
4. **合规性**: 确保遵守金融数据使用规定

---

## 📊 当前实现总结

✅ **已完成**:
- NLP意图识别
- 12种期权策略映射
- Payoff曲线计算和可视化
- 风险指标计算
- 前后端完整集成

⏳ **待添加**:
- Black-Scholes定价
- 实时市场数据
- 希腊字母计算
- 隐含波动率
- 参数交互调整

---

**最后更新**: 2024-10-22  
**作者**: AI Assistant  
**版本**: v1.0

