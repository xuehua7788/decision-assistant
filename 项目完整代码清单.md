# 📦 Decision Assistant - 完整项目代码清单

## 📂 项目结构

```
decision-assistant/
│
├── 📁 frontend/                          # React 前端应用
│   ├── 📁 public/
│   │   └── index.html                   # HTML 模板
│   ├── 📁 src/
│   │   ├── App.js                       # 主应用组件 ⚠️ 需修改
│   │   ├── App.css                      # 样式文件
│   │   ├── ChatViewer.js                # 聊天查看器组件
│   │   ├── index.js                     # 入口文件
│   │   └── index.css                    # 全局样式
│   ├── package.json                     # 依赖配置
│   ├── vercel.json                      # Vercel 配置
│   └── README.md
│
├── 📁 backend/                           # FastAPI 后端
│   ├── 📁 app/
│   │   ├── __init__.py
│   │   ├── main.py                      # FastAPI 入口 ⚠️ 需修改
│   │   ├── 📁 routes/
│   │   │   ├── __init__.py
│   │   │   └── decision_routes.py       # API 路由
│   │   ├── 📁 services/
│   │   │   ├── __init__.py
│   │   │   ├── ai_service.py            # AI 服务 ⚠️ 需修改
│   │   │   └── chat_storage.py          # 聊天存储
│   │   ├── 📁 algorithms/
│   │   │   └── decision_algorithms.py   # 决策算法
│   │   └── 📁 models/
│   │       └── database_models.py       # 数据模型
│   ├── 📁 chat_data/                     # 聊天数据存储
│   │   └── *.json                       # 会话文件
│   ├── requirements.txt                 # Python 依赖
│   └── Dockerfile                       # Docker 配置
│
├── 📁 chat_data/                         # 根目录聊天数据（可选）
│
├── 📁 文档/
│   ├── README.md                        # 项目总览
│   ├── TECHNICAL_SUMMARY.md             # 技术总结
│   ├── VERCEL_DEPLOYMENT_GUIDE.md       # Vercel 部署指南
│   ├── 重新部署指南.md                   # 完整部署教程
│   └── 用户管理和分析方案.md             # 用户功能方案
│
├── vercel.json                          # 根目录 Vercel 配置 ✨ 新建
├── docker-compose.yml                   # Docker Compose
├── .gitignore
└── index.html                           # ❌ 旧版（不要部署这个）

```

---

## 🎯 核心文件内容

---

### 1️⃣ 前端核心文件

#### 📄 `frontend/package.json`

```json
{
  "name": "decision-assistant",
  "version": "1.0.0",
  "private": true,
  "dependencies": {
    "react": "^17.0.2",
    "react-dom": "^17.0.2",
    "react-scripts": "5.0.1",
    "web-vitals": "^5.1.0"
  },
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test",
    "eject": "react-scripts eject"
  },
  "eslintConfig": {
    "extends": [
      "react-app",
      "react-app/jest"
    ]
  },
  "browserslist": [
    ">0.2%",
    "not dead",
    "not ie 11"
  ]
}
```

---

#### 📄 `frontend/vercel.json`

```json
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "build"
      }
    }
  ],
  "routes": [
    {
      "src": "/static/(.*)",
      "dest": "/static/$1"
    },
    {
      "src": "/(.*)",
      "dest": "/index.html"
    }
  ]
}
```

---

#### 📄 `frontend/src/App.js` ⚠️ **需要修改此文件**

**当前代码（需要修改的部分）：**

```javascript
// 第 49 行 - Decision Analysis API 调用
const response = await fetch('http://localhost:8000/api/decisions/analyze', {
  // ...
});

// 第 78 行 - Chat Mode API 调用
const response = await fetch('http://localhost:8000/api/decisions/chat', {
  // ...
});
```

**修改后的代码：**

```javascript
import React, { useState } from 'react';
import './App.css';
import ChatViewer from './ChatViewer';

function App() {
  // ✨ 添加这一行：使用环境变量
  const API_URL = process.env.REACT_APP_API_URL || 'http://localhost:8000';

  const [currentMode, setCurrentMode] = useState('analysis');
  const [description, setDescription] = useState('');
  const [options, setOptions] = useState(['', '']);
  const [chatMessages, setChatMessages] = useState([
    { type: 'assistant', text: "Hello! I'm your decision assistant..." }
  ]);
  const [chatInput, setChatInput] = useState('');
  const [result, setResult] = useState(null);
  const [loading, setLoading] = useState(false);

  // ... 其他函数 ...

  const analyzeDecision = async () => {
    const validOptions = options.filter(o => o.trim() !== '');
    
    if (!description || validOptions.length === 0) {
      alert('Please provide a description and at least one option');
      return;
    }

    setLoading(true);
    setResult(null);

    try {
      // ✨ 修改这里：使用 API_URL 变量
      const response = await fetch(`${API_URL}/api/decisions/analyze`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          description: description,
          options: validOptions
        })
      });
      
      const data = await response.json();
      setResult(data);
      setLoading(false);
    } catch (error) {
      setResult({
        recommendation: 'Error',
        readable_summary: 'Could not connect to server: ' + error.message
      });
      setLoading(false);
    }
  };

  const sendMessage = async () => {
    if (!chatInput.trim()) return;

    setChatMessages([...chatMessages, { type: 'user', text: chatInput }]);
    const userMessage = chatInput;
    setChatInput('');

    try {
      // ✨ 修改这里：使用 API_URL 变量
      const response = await fetch(`${API_URL}/api/decisions/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: userMessage })
      });
      
      const data = await response.json();
      setChatMessages(prev => [...prev, { type: 'assistant', text: data.response }]);
    } catch (error) {
      setChatMessages(prev => [...prev, { type: 'assistant', text: 'Error: Could not connect to server' }]);
    }
  };

  return (
    // ... JSX 代码保持不变 ...
  );
}

export default App;
```

**修改要点：**
1. 第 6 行：添加 `const API_URL = process.env.REACT_APP_API_URL || 'http://localhost:8000';`
2. 第 49 行：改为 `fetch(\`${API_URL}/api/decisions/analyze\`, {`
3. 第 78 行：改为 `fetch(\`${API_URL}/api/decisions/chat\`, {`

---

#### 📄 `frontend/src/ChatViewer.js`

```javascript
import React, { useState, useEffect } from 'react';

function ChatViewer() {
  const [sessions, setSessions] = useState([]);
  const [selectedSession, setSelectedSession] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // API URL 配置（支持环境变量）
  const API_URL = process.env.REACT_APP_API_URL || 'http://localhost:8000';

  useEffect(() => {
    fetchSessions();
  }, []);

  const fetchSessions = async () => {
    try {
      setLoading(true);
      setError(null);
      const response = await fetch(`${API_URL}/api/decisions/sessions`);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      setSessions(data);
      setLoading(false);
    } catch (error) {
      console.error('Failed to fetch sessions:', error);
      setError('无法连接到服务器');
      setLoading(false);
    }
  };

  const viewSession = async (sessionId) => {
    try {
      const response = await fetch(`${API_URL}/api/decisions/session/${sessionId}`);
      const data = await response.json();
      setSelectedSession(data);
    } catch (error) {
      console.error('Failed to fetch session:', error);
      alert('加载会话失败：' + error.message);
    }
  };

  // ... 渲染代码（保持不变）...
}

export default ChatViewer;
```

---

#### 📄 `frontend/src/index.js`

```javascript
import React from 'react';
import ReactDOM from 'react-dom';
import './index.css';
import App from './App';

ReactDOM.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
  document.getElementById('root')
);
```

---

### 2️⃣ 后端核心文件

#### 📄 `backend/requirements.txt`

```
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.4.2
python-multipart==0.0.6
numpy==1.24.3
requests==2.31.0
python-dotenv==1.0.0
```

---

#### 📄 `backend/app/main.py` ⚠️ **需要修改此文件**

**完整代码：**

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI(title="Decision Assistant API")

# ⚠️ CORS 配置 - 需要添加你的 Vercel 域名
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",  # 本地开发
        "https://your-app.vercel.app",  # ✨ 改成你的 Vercel 域名
        "https://*.vercel.app",  # 允许所有 Vercel 预览
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# 导入并注册路由
from app.routes import decision_routes
from app.services.chat_storage import chat_storage
from app.services.ai_service import ai_service

app.include_router(decision_routes.router, prefix="/api/decisions", tags=["decisions"])
print("✓ AI-powered decision routes loaded successfully")
print(f"✓ Chat storage initialized at: {chat_storage.storage_dir}")
print(f"✓ AI service ready: DeepSeek API")

@app.get("/")
async def root():
    return {"message": "Decision Assistant API is running"}

@app.get("/health")
async def health_check():
    return {"status": "healthy", "service": "backend", "ai": "DeepSeek"}

@app.get("/api/test")
async def test_endpoint():
    return {"message": "Test endpoint working"}
```

**修改要点：**
- 第 12 行：将 `"https://your-app.vercel.app"` 改成你实际的 Vercel 域名

---

#### 📄 `backend/app/services/ai_service.py` ⚠️ **需要修改此文件**

**当前代码（第 12 行）：**

```python
self.api_key = os.getenv("DEEPSEEK_API_KEY", "sk-d3196d8e68c44690998d79c715ce715d")
```

**修改后：**

```python
self.api_key = os.getenv("DEEPSEEK_API_KEY")  # ✨ 移除默认值
```

**完整文件：**

```python
import os
from typing import Optional
import requests
import json
from dotenv import load_dotenv

load_dotenv()

class AIService:
    def __init__(self):
        # 使用 DeepSeek API
        self.api_key = os.getenv("DEEPSEEK_API_KEY")  # ✨ 只从环境变量读取
        self.api_url = "https://api.deepseek.com/v1/chat/completions"
        self.ai_available = bool(self.api_key)
    
    def get_response(self, message: str, context: Optional[list] = None) -> str:
        """获取 AI 回复"""
        if not self.ai_available:
            return self._get_mock_response(message)
        
        try:
            messages = self._build_messages(message, context)
            
            headers = {
                "Authorization": f"Bearer {self.api_key}",
                "Content-Type": "application/json"
            }
            
            data = {
                "model": "deepseek-chat",
                "messages": messages,
                "temperature": 0.7,
                "max_tokens": 1000
            }
            
            response = requests.post(self.api_url, headers=headers, json=data)
            
            if response.status_code == 200:
                result = response.json()
                return result['choices'][0]['message']['content']
            else:
                print(f"DeepSeek API error: {response.status_code}")
                return self._get_mock_response(message)
                
        except Exception as e:
            print(f"AI API error: {e}")
            return self._get_mock_response(message)
    
    # ... 其他方法保持不变 ...

# 创建全局实例
ai_service = AIService()
```

---

#### 📄 `backend/app/routes/decision_routes.py`

```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from typing import Optional
import uuid
from app.services.chat_storage import chat_storage
from app.services.ai_service import ai_service

router = APIRouter()

class ChatMessage(BaseModel):
    message: str
    session_id: Optional[str] = None

class ChatResponse(BaseModel):
    response: str
    session_id: str
    total_messages: int

@router.post("/chat", response_model=ChatResponse)
async def chat_with_assistant(chat_message: ChatMessage):
    """处理聊天消息并返回 AI 响应"""
    try:
        session_id = chat_message.session_id or str(uuid.uuid4())
        
        chat_storage.add_message(
            session_id=session_id,
            role="user",
            content=chat_message.message
        )
        
        session_data = chat_storage.get_session(session_id)
        context = session_data.get("messages", []) if session_data else []
        
        ai_response = ai_service.get_response(chat_message.message, context)
        
        chat_storage.add_message(
            session_id=session_id,
            role="assistant",
            content=ai_response
        )
        
        updated_session = chat_storage.get_session(session_id)
        total_messages = len(updated_session.get("messages", []))
        
        return ChatResponse(
            response=ai_response,
            session_id=session_id,
            total_messages=total_messages
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.get("/sessions")
async def get_all_sessions():
    """获取所有会话列表"""
    return chat_storage.get_all_sessions()

@router.get("/session/{session_id}")
async def get_session_history(session_id: str):
    """获取特定会话的历史记录"""
    session_data = chat_storage.get_session(session_id)
    if not session_data:
        raise HTTPException(status_code=404, detail="Session not found")
    return session_data
```

---

#### 📄 `backend/app/services/chat_storage.py`

```python
import json
import os
from datetime import datetime
from typing import Dict, List, Optional
from pathlib import Path

class ChatStorage:
    def __init__(self, storage_dir: str = "chat_data"):
        """初始化聊天存储"""
        self.storage_dir = Path(storage_dir)
        self.storage_dir.mkdir(exist_ok=True)
        
    def add_message(self, session_id: str, role: str, content: str) -> None:
        """添加消息到会话"""
        file_path = self.storage_dir / f"{session_id}.json"
        
        if file_path.exists():
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
        else:
            data = {
                "session_id": session_id,
                "created_at": datetime.now().isoformat(),
                "messages": []
            }
        
        data["messages"].append({
            "role": role,
            "content": content,
            "timestamp": datetime.now().isoformat()
        })
        
        data["last_activity"] = datetime.now().isoformat()
        
        with open(file_path, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
    
    def get_session(self, session_id: str) -> Optional[Dict]:
        """获取会话数据"""
        file_path = self.storage_dir / f"{session_id}.json"
        
        if file_path.exists():
            with open(file_path, 'r', encoding='utf-8') as f:
                return json.load(f)
        return None
    
    def get_all_sessions(self) -> List[Dict]:
        """获取所有会话摘要"""
        sessions = []
        
        for file_path in self.storage_dir.glob("*.json"):
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    summary = {
                        "session_id": data.get("session_id"),
                        "created_at": data.get("created_at"),
                        "last_activity": data.get("last_activity"),
                        "message_count": len(data.get("messages", [])),
                        "first_message": data.get("messages", [{}])[0].get("content", "")[:100] if data.get("messages") else ""
                    }
                    sessions.append(summary)
            except Exception as e:
                print(f"Error reading {file_path}: {e}")
                
        sessions.sort(key=lambda x: x.get("last_activity", ""), reverse=True)
        return sessions
    
    def delete_session(self, session_id: str) -> bool:
        """删除会话"""
        file_path = self.storage_dir / f"{session_id}.json"
        
        if file_path.exists():
            file_path.unlink()
            return True
        return False

# 创建全局实例
chat_storage = ChatStorage()
```

---

### 3️⃣ 配置文件

#### 📄 `vercel.json` （根目录） ✨ **新创建**

```json
{
  "buildCommand": "cd frontend && npm install && npm run build",
  "outputDirectory": "frontend/build",
  "devCommand": "cd frontend && npm start",
  "installCommand": "cd frontend && npm install",
  "framework": null,
  "regions": ["sin1"]
}
```

---

#### 📄 `.gitignore`

```
# Dependencies
node_modules/
__pycache__/
*.pyc

# Build outputs
frontend/build/
backend/dist/

# Environment
.env
.env.local

# IDE
.vscode/
.idea/

# OS
.DS_Store
Thumbs.db

# Data
chat_data/*.json
!chat_data/.gitkeep
```

---

## 📋 部署前需要修改的文件清单

### ✅ 必须修改的 3 个文件

| 文件 | 位置 | 修改内容 |
|------|------|----------|
| **1. frontend/src/App.js** | 第 6 行<br>第 49 行<br>第 78 行 | 添加 `API_URL` 变量<br>使用 `${API_URL}` |
| **2. backend/app/main.py** | 第 12 行 | 添加 Vercel 域名到 CORS |
| **3. backend/app/services/ai_service.py** | 第 12 行 | 移除硬编码的 API Key |

### ✨ 新创建的 1 个文件

| 文件 | 位置 | 作用 |
|------|------|------|
| **vercel.json** | 根目录 | 告诉 Vercel 部署 frontend/ |

---

## 🔑 环境变量配置

### Vercel（前端）

```bash
REACT_APP_API_URL=https://your-backend.onrender.com
```

### Render（后端）

```bash
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxx
PORT=8000
```

---

## 🚀 部署流程总结

### 第 1 步：修改代码

```bash
# 修改 3 个文件 + 创建 1 个文件
1. frontend/src/App.js
2. backend/app/main.py
3. backend/app/services/ai_service.py
4. vercel.json (根目录新建)
```

### 第 2 步：推送到 GitHub

```bash
git add .
git commit -m "配置部署文件"
git push
```

### 第 3 步：Vercel 自动部署

- 检测到 vercel.json
- 自动部署 frontend/
- 大约 2-3 分钟完成

### 第 4 步：部署后端到 Render

- 创建 Web Service
- Root Directory: `backend`
- Start Command: `uvicorn app.main:app --host 0.0.0.0 --port $PORT`

### 第 5 步：配置环境变量

- Vercel: 添加 `REACT_APP_API_URL`
- Render: 添加 `DEEPSEEK_API_KEY`

### 第 6 步：测试

- 访问前端 URL
- 测试功能是否正常
- 检查无 CORS 错误

---

## 📞 快速参考

### 常用命令

```bash
# 本地开发 - 后端
cd backend
uvicorn app.main:app --reload

# 本地开发 - 前端
cd frontend
npm start

# 部署 - 推送代码
git add .
git commit -m "更新"
git push

# Vercel CLI 部署
cd frontend
vercel --prod
```

### API 端点

```
GET  /health                     健康检查
POST /api/decisions/chat         聊天
POST /api/decisions/analyze      决策分析
GET  /api/decisions/sessions     会话列表
GET  /api/decisions/session/:id  会话详情
```

---

**文档版本：** 1.0  
**创建日期：** 2025-10-13  
**包含内容：** 完整项目结构 + 所有核心代码 + 部署指南


