# 📋 查看用户聊天记录指南

## 🎯 概述

本项目提供了多种方式来查看和管理用户的聊天记录。

---

## 🔧 使用工具

### 1️⃣ **列出所有用户和会话**

```bash
python list_users.py
```

**输出示例：**
```
================================================================================
👥 所有用户
================================================================================
总用户数: 1

📧 testuser_2186089695936
   创建时间: ee94a1e4f4cbb4976a21d56955966f01
   有密码: ✅

================================================================================
💬 所有聊天会话
================================================================================
总会话数: 5

📝 test
   消息数: 2
   首条消息: 给我买房子建议...
```

---

### 2️⃣ **查看特定会话的详细内容**

```bash
python quick_view_chat.py <session_id>
```

**示例：**
```bash
python quick_view_chat.py test
python quick_view_chat.py 4e37bb85-c3a6-4eaf-9ec7-b81ce6ca5d5f
```

**输出示例：**
```
================================================================================
📝 会话ID: test
================================================================================
消息总数: 2

--------------------------------------------------------------------------------
[1] USER

给我买房子建议

[1] ASSISTANT

以下是买房的简明建议，帮助你做出明智决策：
...
```

---

### 3️⃣ **交互式查看工具**

```bash
python view_user_chat.py
```

**功能菜单：**
```
请选择操作:
1. 查看所有用户
2. 查看所有聊天会话
3. 查看指定用户的聊天
4. 查看指定会话的详细内容
5. 退出
```

---

## 🌐 使用API直接查询

### **查看所有用户**
```bash
curl https://decision-assistant-backend.onrender.com/api/admin/users
```

### **查看所有聊天会话**
```bash
curl https://decision-assistant-backend.onrender.com/api/admin/chats
```

### **查看指定用户的聊天**
```bash
curl https://decision-assistant-backend.onrender.com/api/admin/chats/<username>
```

---

## 📊 数据存储位置

### **生产环境 (Render)**
- **位置**: `/opt/render/project/src/backend/chat_data/`
- **格式**: JSON文件，每个会话一个文件

### **本地开发环境**
- **位置**: `backend/chat_data/` 和 `chat_data/`
- **格式**: JSON文件

### **数据库存储** (已启用)
- **位置**: PostgreSQL数据库 (Render托管)
- **表**: `chat_sessions`, `chat_messages`

---

## 🔍 数据格式

### **旧格式** (向后兼容)
```json
{
  "user": "用户消息",
  "assistant": "AI回复",
  "timestamp": "哈希值"
}
```

### **新格式** (当前使用)
```json
{
  "role": "user/assistant",
  "content": "消息内容",
  "timestamp": "2025-09-30T08:14:15.005512"
}
```

---

## 💡 提示

1. **会话ID**: 可以是UUID格式 (如 `4e37bb85-...`) 或自定义字符串 (如 `test`)
2. **用户名**: 注册时创建的用户名
3. **时间戳**: ISO 8601格式 或 哈希值 (旧格式)

---

## 🛠️ 高级查询

### **使用Python脚本**
```python
import requests

# 查看所有会话
r = requests.get('https://decision-assistant-backend.onrender.com/api/admin/chats')
data = r.json()

for session_id, chat in data['chats'].items():
    print(f"会话: {session_id}, 消息数: {chat['total_messages']}")
```

### **使用PowerShell**
```powershell
# 查看所有用户
$users = Invoke-RestMethod -Uri "https://decision-assistant-backend.onrender.com/api/admin/users"
$users | ConvertTo-Json -Depth 5

# 查看所有聊天
$chats = Invoke-RestMethod -Uri "https://decision-assistant-backend.onrender.com/api/admin/chats"
$chats | ConvertTo-Json -Depth 5
```

---

## 🔐 安全注意事项

⚠️ **警告**: Admin API目前没有认证保护，建议：

1. **添加认证中间件**
2. **限制IP访问**
3. **使用API密钥**
4. **部署时配置防火墙规则**

---

## 📚 相关文档

- [用户管理和分析方案.md](./用户管理和分析方案.md)
- [用户认证功能说明.md](./用户认证功能说明.md)
- [TECHNICAL_SUMMARY.md](./TECHNICAL_SUMMARY.md)

---

## ❓ 常见问题

### Q: 为什么有些会话ID是UUID，有些是字符串？
A: UUID是自动生成的唯一标识符，字符串是测试时手动指定的。

### Q: 旧格式和新格式有什么区别？
A: 新格式更标准化，支持更多角色类型和更精确的时间戳。

### Q: 如何删除某个会话？
A: 目前需要手动删除 `chat_data/` 目录下的对应JSON文件。

---

**最后更新**: 2025-10-17

