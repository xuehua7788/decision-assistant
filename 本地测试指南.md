# 🧪 Decision Assistant - 本地测试指南

> **在部署到 Vercel 和 Railway 之前，完整测试所有核心功能**

---

## 📋 测试前准备工作

### 1️⃣ 环境要求

```bash
✅ Python 3.8 或更高版本
✅ Node.js 14 或更高版本
✅ npm 或 yarn
✅ DeepSeek API Key（用于测试 AI 功能）
```

检查版本：
```bash
python --version   # 或 python3 --version
node --version
npm --version
```

---

### 2️⃣ 获取 DeepSeek API Key

#### 方式 1：使用真实的 DeepSeek API Key（推荐）

1. **注册 DeepSeek 账号**
   - 访问：https://platform.deepseek.com
   - 注册并登录

2. **获取 API Key**
   - 进入 API Keys 页面
   - 点击 "Create API Key"
   - 复制生成的 Key（格式：`sk-xxxxxxxxxxxxxx`）

3. **配置环境变量**

**Windows (PowerShell):**
```powershell
# 临时设置（当前会话）
$env:DEEPSEEK_API_KEY="sk-你的API密钥"

# 验证
echo $env:DEEPSEEK_API_KEY
```

**Windows (CMD):**
```cmd
set DEEPSEEK_API_KEY=sk-你的API密钥
echo %DEEPSEEK_API_KEY%
```

**Mac/Linux:**
```bash
export DEEPSEEK_API_KEY="sk-你的API密钥"
echo $DEEPSEEK_API_KEY
```

#### 方式 2：创建 .env 文件（推荐）

在 `backend/` 目录创建 `.env` 文件：

```bash
cd backend
```

创建 `.env` 文件，内容如下：
```env
DEEPSEEK_API_KEY=sk-你的API密钥
CHAT_STORAGE_DIR=chat_data
MAX_HISTORY_MESSAGES=20
```

⚠️ **注意：** `.env` 文件不应该提交到 Git，已在 `.gitignore` 中排除

---

## 🚀 启动服务（两种方式）

### 方式 A：使用启动脚本（推荐 - 最快）

#### Windows 用户：

双击运行：
```
启动.bat
```

或使用现有的：
```
start-dev.bat
```

#### Mac/Linux 用户：

```bash
chmod +x start-dev.sh
./start-dev.sh
```

---

### 方式 B：手动启动（逐步控制）

#### 步骤 1：启动后端

**打开终端 1（后端）：**

```bash
# 进入后端目录
cd backend

# 安装依赖（首次运行或依赖更新时）
pip install -r requirements.txt

# 启动后端服务
uvicorn app.main:app --reload
```

**成功标志：**
```
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [xxxxx] using WatchFiles
INFO:     Started server process [xxxxx]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
Chat storage initialized at: chat_data
Settings loaded. Max history messages: 20
DeepSeek API key loaded.  ← 看到这个说明 API Key 配置成功
```

⚠️ **如果看到：** `Warning: DeepSeek API key is not set.`
- 说明 API Key 未正确配置
- 返回上一步检查环境变量或 .env 文件

---

#### 步骤 2：启动前端

**打开终端 2（前端）：**

```bash
# 进入前端目录
cd frontend

# 安装依赖（首次运行）
npm install

# 启动前端服务
npm start
```

**成功标志：**
```
Compiled successfully!

You can now view decision-assistant in the browser.

  Local:            http://localhost:3000
  On Your Network:  http://192.168.x.x:3000

Note that the development build is not optimized.
To create a production build, use npm run build.

webpack compiled successfully
```

浏览器会自动打开 `http://localhost:3000`

---

## ✅ 核心功能测试清单

### 🧪 测试 1：后端健康检查

**目的：** 确认后端服务正常运行

**步骤：**

1. 打开浏览器访问：`http://localhost:8000/health`

2. 或使用命令行：
   ```bash
   curl http://localhost:8000/health
   ```

**预期结果：**
```json
{
  "status": "ok"
}
```

✅ **通过标准：** 返回状态码 200，包含 "ok" 状态

---

### 🧪 测试 2：API 文档访问

**目的：** 确认 FastAPI 文档可访问

**步骤：**

访问：`http://localhost:8000/docs`

**预期结果：**
- 看到 Swagger UI 界面
- 显示所有 API 端点：
  - `GET /health`
  - `GET /`
  - `POST /chat`
  - `GET /sessions`
  - `GET /sessions/{session_id}`
  - `DELETE /sessions/{session_id}`

✅ **通过标准：** 文档页面正常显示，可展开查看 API 详情

---

### 🧪 测试 3：智能聊天功能 ⭐ 核心测试

**目的：** 测试 AI 聊天是否正常工作（最重要的测试）

#### 方法 A：使用前端界面测试（推荐）

**步骤：**

1. **打开前端页面**
   - 访问：`http://localhost:3000`

2. **切换到聊天模式**
   - 点击顶部的 "💬 Chat Mode" 按钮

3. **发送测试消息**

   **测试用例 1：简单问候**
   ```
   用户输入：你好，请介绍一下你自己
   ```

   **预期 AI 回复：**
   - 应该收到 DeepSeek AI 的回复
   - 回复内容应该是关于 AI 助手的自我介绍
   - 响应时间：3-10 秒

   **测试用例 2：决策咨询**
   ```
   用户输入：我在考虑是否要换工作，应该考虑哪些因素？
   ```

   **预期 AI 回复：**
   - 应该列出相关的决策因素
   - 回复内容逻辑清晰、有条理
   - 包含实用建议

   **测试用例 3：上下文记忆测试**
   ```
   第一条消息：我想买一台笔记本电脑，预算 5000 元
   第二条消息：那推荐哪个品牌？  ← 测试 AI 是否记住预算
   ```

   **预期 AI 回复：**
   - AI 应该记住之前提到的 5000 元预算
   - 推荐符合预算的品牌

4. **检查聊天历史保存**
   - 刷新页面
   - 聊天记录应该不会丢失（前端状态刷新会清空，但后端已保存）

**通过标准：**
- ✅ 消息发送成功
- ✅ AI 回复正常且相关
- ✅ 上下文记忆有效
- ✅ 无错误提示

---

#### 方法 B：使用 API 直接测试

**使用 curl 测试：**

```bash
# 测试聊天 API
curl -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "test-session-local",
    "message": "你好，请介绍一下你自己"
  }'
```

**预期返回：**
```json
{
  "response": "你好！我是一个AI助手...",
}
```

**使用 Python 测试：**

创建 `test_chat.py`：

```python
import requests
import json

API_URL = "http://localhost:8000"

# 测试 1：发送消息
def test_chat():
    response = requests.post(
        f"{API_URL}/chat",
        json={
            "session_id": "test-python-123",
            "message": "你好，请用一句话介绍你自己"
        }
    )
    
    print(f"状态码: {response.status_code}")
    print(f"响应: {json.dumps(response.json(), ensure_ascii=False, indent=2)}")
    
    if response.status_code == 200:
        print("✅ 聊天测试通过")
    else:
        print("❌ 聊天测试失败")

# 测试 2：获取会话列表
def test_sessions():
    response = requests.get(f"{API_URL}/sessions")
    
    print(f"\n会话列表: {json.dumps(response.json(), ensure_ascii=False, indent=2)}")
    
    if response.status_code == 200:
        print("✅ 会话列表测试通过")
    else:
        print("❌ 会话列表测试失败")

if __name__ == "__main__":
    test_chat()
    test_sessions()
```

运行测试：
```bash
python test_chat.py
```

---

### 🧪 测试 4：决策分析功能

**目的：** 测试决策算法是否正常工作

**步骤：**

1. **访问前端**：`http://localhost:3000`

2. **确保在 "Decision Analysis" 模式**（默认模式）

3. **输入测试数据**

   **测试场景：购买笔记本电脑**
   
   **决策描述：**
   ```
   我需要买一台新的笔记本电脑用于编程和日常使用
   ```

   **选项 1：**
   ```
   MacBook Pro M3 - 价格较高但性能优秀
   ```

   **选项 2：**
   ```
   联想 ThinkPad - 性价比高，价格适中
   ```

   **选项 3：**
   ```
   戴尔 XPS - 设计精美，性能均衡
   ```

4. **点击 "Analyze My Decision" 按钮**

5. **检查分析结果**

**预期结果：**

应该显示：
- ✅ **推荐选项**（Recommendation）
- ✅ **详细总结**（Summary）- AI 生成的可读分析
- ✅ **评分分析**（Score Analysis）- 每个选项的评分

**示例输出：**
```
✓ Recommendation: 联想 ThinkPad - 性价比高，价格适中

📊 Summary:
Based on comprehensive analysis, '联想 ThinkPad - 性价比高，价格适中' is recommended.
• Weighted Score: 7.5/10
• Pros: 3 identified
• Cons: 2 identified

📈 Score Analysis:
联想 ThinkPad - 性价比高，价格适中    7.5/10
MacBook Pro M3 - 价格较高但性能优秀   7.2/10
戴尔 XPS - 设计精美，性能均衡        6.8/10
```

**通过标准：**
- ✅ 分析完成（10-30 秒内）
- ✅ 显示推荐选项
- ✅ 显示评分数据
- ✅ 生成可读的总结
- ✅ 无错误信息

---

### 🧪 测试 5：聊天记录查看功能

**目的：** 验证聊天记录的保存和查看

**步骤：**

#### 方法 A：使用 API 查看

1. **获取所有会话**
   ```bash
   curl http://localhost:8000/sessions
   ```

   **预期返回：**
   ```json
   [
     {
       "session_id": "test-session-local",
       "created_at": "2025-10-14T...",
       "last_activity": "2025-10-14T...",
       "message_count": 3,
       "first_message": "你好，请介绍一下你自己"
     }
   ]
   ```

2. **查看特定会话**
   ```bash
   curl http://localhost:8000/sessions/test-session-local
   ```

   **预期返回：**
   ```json
   {
     "session_id": "test-session-local",
     "created_at": "2025-10-14T10:30:00",
     "last_activity": "2025-10-14T10:35:00",
     "messages": [
       {
         "role": "user",
         "content": "你好，请介绍一下你自己",
         "timestamp": "2025-10-14T10:30:00"
       },
       {
         "role": "assistant",
         "content": "你好！我是一个AI助手...",
         "timestamp": "2025-10-14T10:30:05"
       }
     ]
   }
   ```

#### 方法 B：查看 JSON 文件

```bash
# Windows
cd backend\chat_data
dir
type test-session-local.json

# Mac/Linux
cd backend/chat_data
ls -lh
cat test-session-local.json
```

#### 方法 C：使用 PowerShell 脚本（Windows）

```powershell
.\ViewChatUTF8.ps1
```

**通过标准：**
- ✅ 可以获取会话列表
- ✅ 可以查看会话详情
- ✅ JSON 文件正确保存
- ✅ 时间戳格式正确

---

### 🧪 测试 6：错误处理测试

**目的：** 验证系统的错误处理能力

#### 测试场景 1：无 API Key 的情况

1. **停止后端服务**（Ctrl+C）

2. **临时移除 API Key**
   ```bash
   # Windows
   $env:DEEPSEEK_API_KEY=""
   
   # Mac/Linux
   unset DEEPSEEK_API_KEY
   ```

3. **重启后端**
   ```bash
   cd backend
   uvicorn app.main:app --reload
   ```

4. **发送聊天消息**

**预期行为：**
- ✅ 系统应该显示警告：`Warning: DeepSeek API key is not set.`
- ✅ 聊天应该返回模拟回复（mock response）而不是崩溃
- ✅ 前端显示回复（虽然不是真实 AI）

#### 测试场景 2：后端服务未启动

1. **停止后端服务**

2. **在前端发送消息**

**预期行为：**
- ✅ 前端显示错误消息："Could not connect to server"
- ✅ 不会导致前端崩溃

#### 测试场景 3：无效的会话 ID

```bash
curl http://localhost:8000/sessions/invalid-session-id-999
```

**预期返回：**
```json
{
  "error": "Session not found"
}
```

---

## 📊 完整测试检查表

打印此清单，逐项测试：

```
📋 本地测试检查表

环境准备
□ Python 3.8+ 已安装
□ Node.js 14+ 已安装
□ DeepSeek API Key 已获取
□ 环境变量已配置（或 .env 文件已创建）

服务启动
□ 后端成功启动（端口 8000）
□ 前端成功启动（端口 3000）
□ 看到 "DeepSeek API key loaded" 消息
□ 浏览器自动打开前端页面

基础功能测试
□ /health 端点返回 200 OK
□ /docs 文档页面可访问
□ 前端页面正常显示

智能聊天功能（核心）
□ 可以发送消息
□ AI 正常回复（3-10 秒内）
□ 回复内容相关且合理
□ 上下文记忆有效（连续对话测试）
□ 消息历史显示正确

决策分析功能
□ 可以添加/删除选项
□ 分析按钮有效
□ 显示推荐结果
□ 显示评分数据
□ 显示 AI 总结

数据持久化
□ 聊天记录保存到 chat_data/
□ 可以获取会话列表
□ 可以查看会话详情
□ JSON 文件格式正确

错误处理
□ 无 API Key 时有友好提示
□ 后端断开时前端不崩溃
□ 无效请求有错误消息

性能检查
□ 聊天响应时间 < 10 秒
□ 决策分析时间 < 30 秒
□ 前端界面流畅无卡顿
```

---

## 🐛 常见问题排查

### 问题 1：AI 不回复或超时

**症状：**
- 发送消息后一直等待
- 或显示错误："Could not get AI response"

**排查步骤：**

1. **检查 API Key**
   ```bash
   # 查看后端启动日志
   # 应该看到：DeepSeek API key loaded.
   # 如果看到：Warning: DeepSeek API key is not set.
   ```

2. **验证 API Key 有效性**
   ```bash
   curl https://api.deepseek.com/v1/models \
     -H "Authorization: Bearer sk-你的API密钥"
   ```

   应该返回模型列表而不是错误

3. **检查网络连接**
   ```bash
   ping api.deepseek.com
   ```

4. **查看后端日志**
   - 查看终端 1（后端）的错误信息
   - 常见错误：
     - `401 Unauthorized` → API Key 无效
     - `429 Too Many Requests` → 请求频率超限
     - `Timeout` → 网络问题

**解决方案：**
- 确认 API Key 正确且有余额
- 检查网络代理设置
- 等待一段时间后重试（如果是频率限制）

---

### 问题 2：CORS 错误

**症状：**
```
Access to fetch at 'http://localhost:8000/...' from origin 'http://localhost:3000' 
has been blocked by CORS policy
```

**解决方案：**

检查 `backend/app/core/config.py`：

```python
allowed_origins: List[str] = [
    "http://localhost:3000",
    "http://127.0.0.1:3000",  # ← 确保包含这两个
]
```

或者在开发环境临时使用：
```python
# backend/app/main.py
allow_origins=["*"]  # 仅用于本地测试
```

---

### 问题 3：前端显示空白页面

**排查：**

1. **查看浏览器控制台**（F12）
   - 查看 Console 标签的错误信息
   - 查看 Network 标签的请求状态

2. **检查 API_URL 配置**
   ```javascript
   // frontend/src/App.js 第 6 行
   const API_URL = process.env.REACT_APP_API_URL || 'http://localhost:8000';
   ```

3. **清除缓存重试**
   ```bash
   cd frontend
   rm -rf node_modules package-lock.json
   npm install
   npm start
   ```

---

### 问题 4：聊天记录不保存

**排查：**

1. **检查 chat_data 目录**
   ```bash
   ls -lh backend/chat_data/
   ```

2. **检查目录权限**
   - 确保后端进程有写入权限

3. **查看后端日志**
   - 启动时应显示：`Chat storage initialized at: chat_data`

---

## 🎯 性能基准测试

### 聊天响应时间

**测试方法：**

```python
# test_performance.py
import time
import requests

API_URL = "http://localhost:8000"

def test_chat_response_time():
    message = "请用一句话介绍人工智能"
    
    start_time = time.time()
    response = requests.post(
        f"{API_URL}/chat",
        json={
            "session_id": "perf-test",
            "message": message
        }
    )
    end_time = time.time()
    
    response_time = end_time - start_time
    
    print(f"响应时间: {response_time:.2f} 秒")
    
    if response_time < 10:
        print("✅ 性能良好")
    elif response_time < 20:
        print("⚠️ 性能一般")
    else:
        print("❌ 响应过慢")

test_chat_response_time()
```

**性能标准：**
- ✅ 优秀：< 5 秒
- ⚠️ 良好：5-10 秒
- ❌ 需优化：> 10 秒

---

## 📝 测试报告模板

完成测试后，填写此报告：

```
Decision Assistant 本地测试报告
===================================

测试日期：2025-10-14
测试人员：[你的名字]
测试环境：Windows 10 / macOS / Linux

一、环境配置
- Python 版本：_____
- Node.js 版本：_____
- DeepSeek API Key：已配置 ✓ / 未配置 ✗

二、服务启动
- 后端启动：成功 ✓ / 失败 ✗
- 前端启动：成功 ✓ / 失败 ✗
- 端口占用：无冲突 ✓ / 有冲突 ✗

三、功能测试
1. 智能聊天：通过 ✓ / 失败 ✗
   - 响应时间：_____ 秒
   - 回复质量：优秀 / 良好 / 一般
   
2. 决策分析：通过 ✓ / 失败 ✗
   - 分析时间：_____ 秒
   - 结果准确性：是 / 否
   
3. 聊天记录：通过 ✓ / 失败 ✗
   - 保存正常：是 / 否
   - 查看正常：是 / 否

四、问题记录
- [问题 1]：_____
- [问题 2]：_____

五、测试结论
□ 所有功能正常，可以部署
□ 部分功能有问题，需修复：_____
□ 无法通过测试，需重新配置
```

---

## ✅ 测试通过后的下一步

当所有测试通过后：

1. **保存测试数据**
   ```bash
   # 备份测试会话数据（可选）
   cp -r backend/chat_data backend/chat_data_backup
   ```

2. **准备部署**
   - 参考：`TECHNICAL_SUMMARY.md`（部署修改清单）
   - 参考：`重新部署指南.md`（完整部署教程）

3. **修改配置文件**
   - `frontend/src/App.js` - 使用环境变量
   - `backend/app/main.py` - 添加生产域名到 CORS
   - `backend/app/services/ai_service.py` - 移除硬编码 API Key

4. **提交代码**
   ```bash
   git add .
   git commit -m "准备部署：已完成本地测试"
   git push
   ```

5. **开始部署**
   - 后端 → Railway/Render
   - 前端 → Vercel

---

## 🎓 测试技巧总结

### 高效测试流程

1. **先测基础，后测复杂**
   - 先确保服务能启动
   - 再测试 API 健康检查
   - 最后测试完整功能

2. **保留测试数据**
   - 创建固定的测试 session_id
   - 便于重复测试和调试

3. **使用多种方法验证**
   - 前端界面测试（用户体验）
   - API 直接测试（功能验证）
   - 文件系统检查（数据持久化）

4. **记录每次测试**
   - 记录测试时间、结果、问题
   - 便于追踪和改进

---

**文档版本：** 1.0  
**创建日期：** 2025-10-14  
**适用场景：** 本地开发和测试

**📌 记住：完整的本地测试是成功部署的关键！**

