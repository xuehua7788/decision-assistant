# 🎯 Decision Assistant - 项目需求和实施计划

---

## 📋 项目核心需求

### 需求 1：前后端分开部署

**需求描述：**
- 前端（React）部署到 Vercel
- 后端（FastAPI）部署到 Render.com
- 前后端通过 API 进行通信
- 支持独立扩展和维护

**业务价值：**
- 前端享受 Vercel 的全球 CDN 加速
- 后端可以独立升级和维护
- 降低部署成本（前端免费）
- 提高系统稳定性

**技术要求：**
- 前端需要配置环境变量连接后端
- 后端需要配置 CORS 允许前端域名
- 支持 HTTPS 安全通信

---

### 需求 2：区分客户 ID

**需求描述：**
- 系统能够识别和区分不同的用户
- 每个用户有唯一的 ID
- 可以追踪同一用户的多次访问和对话
- 支持查询特定用户的所有历史记录

**业务价值：**
- 了解用户使用频率和习惯
- 提供个性化服务
- 进行用户行为分析
- 支持用户画像构建

**技术要求：**
- 用户首次访问自动生成 `user_id`
- `user_id` 存储在浏览器 localStorage
- 每次 API 请求携带 `user_id`
- 后端存储时关联 `user_id`

**数据结构：**
```json
{
  "session_id": "xxx-xxx-xxx",
  "user_id": "user-123456789",  // 用户唯一标识
  "created_at": "2025-10-13T10:30:45",
  "messages": [...]
}
```

---

### 需求 3：存储客户聊天记录

**需求描述：**
- 永久保存所有用户的聊天记录
- 支持查询历史对话
- 数据结构化存储
- 支持数据导出和分析

**业务价值：**
- 提供聊天历史查看功能
- 支持对话数据分析
- 改进 AI 回复质量
- 作为用户服务记录

**技术要求：**
- 实时保存每条消息
- 包含完整的上下文信息
- 支持按用户、时间等维度查询
- 数据安全和隐私保护

**存储结构：**
```
chat_data/
├── session-1.json  {"user_id": "user-123", "messages": [...]}
├── session-2.json  {"user_id": "user-123", "messages": [...]}
└── session-3.json  {"user_id": "user-456", "messages": [...]}
```

---

## 📊 当前实施状态

| 需求 | 状态 | 完成度 | 说明 |
|------|------|--------|------|
| **1. 前后端分开部署** | 🟡 进行中 | 70% | 代码准备好，需部署和配置 |
| **2. 区分客户ID** | ⚪ 未开始 | 0% | 方案已确定，等待实施 |
| **3. 存储聊天记录** | ✅ 已实现 | 100% | 功能正常，需优化持久化 |

---

## 🗓️ 实施计划

### 阶段一：基础部署（第1周）✨ 当前阶段

**目标：** 实现需求 1（前后端分开部署）

**任务清单：**

#### 1.1 代码准备
- [x] 创建部署文档
- [x] 创建配置文件模板
- [ ] 修改 `frontend/src/App.js` 支持环境变量
- [ ] 修改 `backend/app/main.py` 配置 CORS
- [ ] 修改 `backend/app/services/ai_service.py` 移除硬编码
- [ ] 创建根目录 `vercel.json` 配置文件

#### 1.2 部署前端到 Vercel
- [ ] 修复 Vercel 部署配置
- [ ] 推送代码到 GitHub
- [ ] 等待 Vercel 自动部署
- [ ] 验证前端访问正常

#### 1.3 部署后端到 Render
- [ ] 注册 Render.com 账号
- [ ] 创建 Web Service
- [ ] 配置构建参数
- [ ] 设置环境变量（DEEPSEEK_API_KEY）
- [ ] 等待部署完成
- [ ] 验证后端 API 正常

#### 1.4 连接前后端
- [ ] 在 Vercel 配置环境变量（REACT_APP_API_URL）
- [ ] 更新后端 CORS 允许 Vercel 域名
- [ ] 重新部署前端
- [ ] 测试前后端通信

#### 1.5 功能测试
- [ ] Decision Analysis 功能测试
- [ ] Chat Mode 功能测试
- [ ] Chat Viewer 功能测试
- [ ] 跨域请求无错误
- [ ] 响应速度正常

**预计时间：** 2-3 天  
**完成标志：** 前后端都在云端运行，用户可以正常使用

---

### 阶段二：用户识别（第2周）

**目标：** 实现需求 2（区分客户ID）

**任务清单：**

#### 2.1 后端改造
- [ ] 修改 `chat_storage.py` 添加 `user_id` 参数
- [ ] 修改 `decision_routes.py` 接收 `user_id`
- [ ] 添加用户查询 API `/user/{user_id}/sessions`
- [ ] 添加用户统计 API `/user/{user_id}/stats`

#### 2.2 前端改造
- [ ] 在 `App.js` 生成和存储 `user_id`
- [ ] 所有 API 请求携带 `user_id`
- [ ] 创建用户资料页面组件

#### 2.3 数据迁移
- [ ] 为现有会话数据添加 `user_id` 字段
- [ ] 测试新旧数据兼容性

#### 2.4 功能验证
- [ ] 同一用户的多次对话能关联
- [ ] 可以查询用户所有会话
- [ ] 用户统计数据正确

**预计时间：** 3-4 天  
**完成标志：** 系统能识别和追踪不同用户

---

### 阶段三：用户分析（第3周）

**目标：** 基于需求 2 实现用户行为分析

**任务清单：**

#### 3.1 分析功能
- [ ] 实现用户行为分析 API
- [ ] 使用 AI 分析用户决策偏好
- [ ] 生成用户画像

#### 3.2 个性化服务
- [ ] 基于历史的个性化回复
- [ ] 用户偏好推荐

#### 3.3 数据可视化
- [ ] 用户统计图表
- [ ] 对话趋势分析

**预计时间：** 4-5 天  
**完成标志：** 能对用户行为进行分析并提供个性化服务

---

### 阶段四：存储优化（第4周）

**目标：** 优化需求 3（数据持久化）

**任务清单：**

#### 4.1 评估存储方案
- [ ] 评估 Render 免费版限制
- [ ] 考虑升级付费版（$7/月）
- [ ] 或引入 PostgreSQL 数据库

#### 4.2 数据库迁移（如果需要）
- [ ] 设计数据库表结构
- [ ] 编写迁移脚本
- [ ] 从 JSON 迁移到数据库
- [ ] 测试数据完整性

#### 4.3 数据备份
- [ ] 实现自动备份机制
- [ ] 定期导出数据
- [ ] 数据恢复测试

**预计时间：** 3-5 天  
**完成标志：** 数据永久保存，重启不丢失

---

## 📐 技术架构

### 当前架构

```
用户浏览器
    │
    ↓
┌─────────────────┐
│  Vercel (前端)  │
│  - React        │
│  - 静态资源     │
└────────┬────────┘
         │ API
         ↓
┌─────────────────┐
│  Render (后端)  │
│  - FastAPI      │
│  - DeepSeek AI  │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│  文件存储       │
│  chat_data/*.json│
└─────────────────┘
```

### 目标架构（完成后）

```
用户浏览器 (带 user_id)
    │
    ↓
┌─────────────────┐
│  Vercel (前端)  │
│  - React        │
│  - 用户管理     │
│  - 数据可视化   │
└────────┬────────┘
         │ API (带 user_id)
         ↓
┌─────────────────┐
│  Render (后端)  │
│  - FastAPI      │
│  - 用户识别     │
│  - 行为分析     │
│  - DeepSeek AI  │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│  持久化存储     │
│  - PostgreSQL   │
│  或              │
│  - JSON + 备份  │
└─────────────────┘
```

---

## 🔄 实施策略

### 方案 A：逐步实施（推荐）✨

**优点：**
- 风险低，容易调试
- 每个阶段都有明确产出
- 可以根据反馈调整

**缺点：**
- 总时间较长（4周）
- 需要多次部署

**适合场景：**
- 团队协作开发
- 追求稳定可靠
- 预算充足

---

### 方案 B：快速实施

**时间线：**
```
第1天：实现需求 1 + 需求 2
第2天：测试和部署
第3天：优化和上线
```

**优点：**
- 快速上线
- 功能完整

**缺点：**
- 风险高
- 问题难定位
- 可能需要返工

**适合场景：**
- 个人项目
- 紧急上线
- 技术熟练

---

## 📊 成本估算

### 开发成本

| 阶段 | 工作量 | 人天 |
|------|--------|------|
| 阶段一：部署 | 2-3天 | 3 |
| 阶段二：用户ID | 3-4天 | 4 |
| 阶段三：分析 | 4-5天 | 5 |
| 阶段四：优化 | 3-5天 | 4 |
| **总计** | **12-17天** | **16** |

### 运营成本（月）

| 项目 | 免费方案 | 付费方案 |
|------|---------|---------|
| Vercel（前端） | $0 | $0 |
| Render（后端） | $0 | $7 |
| 数据库 | $0（文件） | $5（PostgreSQL） |
| DeepSeek API | 按量计费 | 按量计费 |
| **总计** | **$0 + API** | **$12 + API** |

---

## ✅ 验收标准

### 需求 1：前后端分开部署

**验收条件：**
- [ ] 前端可以通过 Vercel URL 访问
- [ ] 后端可以通过 Render URL 访问
- [ ] 前端能正常调用后端 API
- [ ] 无 CORS 错误
- [ ] 所有功能正常运行
- [ ] 响应时间 < 3秒

---

### 需求 2：区分客户ID

**验收条件：**
- [ ] 每个用户有唯一 ID
- [ ] 用户 ID 存储在浏览器
- [ ] 可以查询用户所有会话
- [ ] 可以统计用户行为
- [ ] 用户切换设备后生成新 ID（预期行为）
- [ ] 用户清除缓存后生成新 ID（预期行为）

---

### 需求 3：存储聊天记录

**验收条件：**
- [ ] 所有对话实时保存
- [ ] 可以查看历史记录
- [ ] 数据包含完整上下文
- [ ] Chat Viewer 功能正常
- [ ] 重启后数据不丢失（如使用付费方案）
- [ ] 支持数据导出

---

## 🔐 安全和隐私

### 数据安全

**当前措施：**
- API Key 存储在服务器环境变量
- CORS 限制前端域名
- HTTPS 加密传输

**需要改进：**
- [ ] 添加 API 访问频率限制
- [ ] 实现用户数据加密
- [ ] 添加敏感信息脱敏

### 隐私保护

**用户数据收集：**
- 用户 ID（自动生成）
- 对话内容
- 时间戳

**隐私承诺：**
- 不收集个人身份信息
- 不分享用户数据
- 支持数据删除请求

---

## 📞 支持文档

### 已创建的文档

1. **项目完整代码清单.md** - 所有代码和文件结构
2. **TECHNICAL_SUMMARY.md** - 部署修改清单
3. **重新部署指南.md** - 完整部署教程
4. **VERCEL_DEPLOYMENT_GUIDE.md** - 详细部署指南
5. **用户管理和分析方案.md** - 用户功能实现方案

### 待创建的文档

- [ ] API 接口文档
- [ ] 数据库设计文档
- [ ] 用户使用手册
- [ ] 运维手册

---

## 🎯 里程碑

### 里程碑 1：基础部署完成 ✨ 当前目标
- **时间：** 第1周结束
- **标志：** 前后端都在云端运行
- **产出：** 可访问的线上应用

### 里程碑 2：用户识别完成
- **时间：** 第2周结束
- **标志：** 系统能区分不同用户
- **产出：** 用户追踪功能

### 里程碑 3：分析功能上线
- **时间：** 第3周结束
- **标志：** 能分析用户行为
- **产出：** 用户画像和个性化服务

### 里程碑 4：生产就绪
- **时间：** 第4周结束
- **标志：** 数据持久化，系统稳定
- **产出：** 可长期运行的生产系统

---

## 🚀 下一步行动

### 立即开始

**现在应该做：**
1. 确认实施方案（方案 A 或 方案 B）
2. 修改代码文件（3个文件）
3. 创建配置文件（1个文件）
4. 推送到 GitHub
5. 开始部署流程

**需要决策：**
- 选择实施方案？
- 预算是否允许付费方案？
- 是否需要数据库？

---

## 📝 变更记录

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|----------|------|
| 2025-10-13 | 1.0 | 创建需求文档 | - |

---

**文档状态：** ✅ 已完成  
**最后更新：** 2025-10-13  
**下次审核：** 每阶段完成后更新

---

**准备好了吗？告诉我你的选择，我们立即开始！** 🚀


